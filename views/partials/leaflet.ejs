<script>
var baseLayer = L.tileLayer(
  'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '...',
    maxZoom: 15
  }
);

var cfg = {
  "radius": 15,
  "maxOpacity": .5, 
  "scaleRadius": false,
  "useLocalExtrema": false,
  latField: 'lat',
  lngField: 'lng',
  valueField: 'count',
  blur: 0.95,
  gradient: { 
  '.5': 'yellow',
  '.8': 'orange',
  '.95': 'red'
  }
};

var min = 1;
var max = 3910;
var data = addressPoints.map(function (p) { 
	// normalize intensity values to between 0 and 1
	var intensity = parseInt(p[2]) || 0;
  var normalized = (intensity - min) / (max - min);
  return { lat: p[0], lng: p[1], count: parseInt(p[2]) || 0 };
});

var testData = {
  max: max,
  min: min,
  data: data
};

var map = new L.Map('map').setView([-37.87, 175.475], 12);
L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {maxZoom: 19}).addTo(map); 

var heatmapLayer = new HeatmapOverlay(cfg).addTo(map);
heatmapLayer.setData(testData);

var now = new Date();
var past = new Date(now.getTime() - 10*60000);
axios.post('http://localhost:3000/v1/resources/data', {'dateFrom': now.toISOString(), 'dateUntil': past.toISOString()}).then(res =>{
  if(res.data.data.length > 0){
    map.setView([res.data.data[0].lat, res.data.data[0].lng], 12);
    heatmapLayer.setData(res.data);
  }
});

$('#send').click(function(e){
  var timeFrom = $("#timeFrom").val();
  var timeUntil = $("#timeUntil").val();
  if(timeFrom == "" && timeUntil == ""){
    $('.error').show();
    return;
  } else if(timeFrom == ""){
    $('.error-from').show();
    return;
  } else if(timeUntil == ""){
    $('.error-until').show();
    return;
  }
  $('.search').show();
  $("#send").attr("disabled", true);
  console.log("time " + new Date(timeFrom).toISOString() + " " + timeUntil);
  axios.post('http://localhost:3000/v1/resources/data', {'dateFrom': new Date(timeFrom).toISOString(), 'dateUntil': new Date(timeUntil).toISOString()}).then(res =>{
    heatmapLayer.setData(res.data);
    map.setView([res.data.data[0].lat, res.data.data[0].lng], 12);
    $('.search').hide();
    $("#send").attr("disabled", false);
  }).catch(error => {
    $('.search').hide();
    $("#send").attr("disabled", false);
  });
})

$('.input').focus(function(e){
  $('.error').hide();
});
</script>